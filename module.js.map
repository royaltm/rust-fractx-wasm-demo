{"version":3,"file":"module.js","sources":["../src/js/wasm-helpers.js","../src/js/module.js"],"sourcesContent":["import {\n  ArrayBuffer,\n  Uint8Array,\n  Uint8ClampedArray,\n  WebAssembly,\n  ImageData,\n  TextDecoder\n} from 'global';\n\nexport const PAGE_SIZE = 65536;\n\nexport function bufferViewOf(constr, buffer, byteOffset, length) {\n  if (ArrayBuffer.isView(buffer)) {\n    byteOffset += buffer.byteOffset;\n    buffer = buffer.buffer;\n  }\n  return new constr(buffer, byteOffset, length);\n}\n\nexport function imageDataLength(width, height) {\n  return width * height * 4;\n}\n\nexport function fetchAndInstantiate(url, importObject) {\n  var promise = fetch(url);\n  if ('function' === typeof WebAssembly.instantiateStreaming) {\n    return WebAssembly.instantiateStreaming(promise, importObject);\n  }\n  else {\n    /* fallback to \"legacy\" slow method */\n    return promise\n    .then(response => response.arrayBuffer())\n    .then(bytes => WebAssembly.instantiate(bytes, importObject));\n  }\n}\n\n// Currently only FF allows to serialize a WebAssembly.Module\nexport function fetchAndSend(url, worker) {\n  var promise = fetch(url);\n  if ('function' === typeof WebAssembly.compileStreaming) {\n    promise = WebAssembly.compileStreaming(promise);\n  }\n  else {\n    /* fallback to \"legacy\" slow method */\n    promise = promise\n    .then(response => response.arrayBuffer())\n    .then(bytes => WebAssembly.compile(bytes));\n  }\n\n  return promise.then(module => {\n    worker.postMessage(module);\n    return {module, worker};\n  });\n}\n\nexport function readCStringFrom(buffer, offset) {\n  var view = bufferViewOf(Uint8Array, buffer, offset);\n  let blen = view.indexOf(0);\n  if (blen < 0) throw new Error(\"could not read a cstring\");\n  buffer = new Uint8Array(view.buffer, offset, blen);\n  return new TextDecoder().decode(buffer);\n}\n\nexport function imageDataFrom(buffer, offset, width, height) {\n  var length = imageDataLength(width, height);\n  var view = bufferViewOf(Uint8ClampedArray, buffer, offset, length);\n  return new ImageData(view, width, height);\n}\n","export * from './wasm-helpers.js'\nimport { fetchAndInstantiate, imageDataFrom } from './wasm-helpers.js'\nimport { WebAssembly, ArrayBuffer } from 'global';\n\nexport const MODULE_URL = 'fractx_wasm_demo.gc.opt.wasm';\n\nexport function instantiateWasmModule(Module, env) {\n  // const memory = new WebAssembly.Memory({initial: 20});\n\n  env = Object.assign({\n    zoom_result(x0, y0, x1, y1) {}\n  // }, env, {memory});\n  }, env);\n\n  const allocCache = new Set();\n\n  return fetchAndInstantiate(MODULE_URL, {env})\n  .then(mod => {\n    const memory = mod.instance.exports.memory;\n    Object.assign(Module, mod.instance.exports, {\n      memory,\n\n      createImageData(w, h) {\n        var ptr = Module.alloc_image_data(w, h);\n        var img = imageDataFrom(memory.buffer, ptr, w, h);\n        allocCache.add(img.data);\n        return img;\n      },\n\n      disposeDataView(view) {\n        if (!ArrayBuffer.isView(view)) {\n          throw new TypeError(\"disposeDataView: view is not a view over ArrayBuffer\");\n        }\n        var {buffer, byteOffset, byteLength} = view;\n        if (buffer !== memory.buffer) {\n          throw new Error(\"disposeDataView: memory was not allocated for module\");\n        }\n        if (allocCache.delete(view)) {\n          Module.dispose_memory(byteOffset, byteLength);\n        }\n      },    \n\n      disposeImageData(image) {\n        Module.disposeDataView(image.data);\n      }\n    });\n\n    return mod;\n  });\n}\n"],"names":["ArrayBuffer","WebAssembly","Uint8Array","TextDecoder","Uint8ClampedArray","ImageData"],"mappings":"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"}